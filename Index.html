<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CostCalc - Project Cost Calculator</title>
    
    <!-- Babel for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for ES Modules -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
          "lucide-react": "https://esm.sh/lucide-react@0.378.0",
          "jspdf": "https://esm.sh/jspdf@2.5.1",
          "jspdf-autotable": "https://esm.sh/jspdf-autotable@3.8.2"
        }
      }
    </script>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
        }
        @media print {
            body * { visibility: hidden; }
            #pdf-export, #pdf-export * { visibility: visible; }
            #pdf-export { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, createContext, useContext, useEffect, useMemo, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { Sun, Moon, Menu, X, Home, FolderKanban, Shield, User, LifeBuoy, LogOut, LogIn, UserPlus, Settings, AlertCircle, Check, Plus, Trash2, Save, FileUp, CalendarDays, BarChart3, Copy, Edit, Bell, Share2, Download, ChevronLeft, ChevronRight, MessageSquare, Mail, Users, BookUser, FileClock, Search, ChevronsUpDown, MoreHorizontal, FileText, DollarSign } from 'lucide-react';
        import jsPDF from 'jspdf';
        import autoTable from 'jspdf-autotable';

        // --- Supabase & API Configuration ---
        const supabaseUrl = 'https://quzmyeiyjdrluuopbbwa.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1em15ZWl5amRybHV1b3BiYndhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDEzNDEsImV4cCI6MjA2ODQxNzM0MX0.PPgPnY6eCGCLuW-EYQhP4fghdJtvreaboVDrHX59vVU';
        const isSupabaseConfigured = supabaseUrl !== 'YOUR_SUPABASE_URL' && supabaseAnonKey !== 'YOUR_SUPABASE_ANON_KEY';
        const supabase = isSupabaseConfigured ? createClient(supabaseUrl, supabaseAnonKey) : null;
        
        const SUPPORTED_CURRENCIES = ['USD', 'EUR', 'GBP', 'CAD', 'AUD', 'JPY', 'CHF', 'CNY'];

        // --- CONTEXTS ---
        const AuthContext = createContext(null);
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            const loadUserAndProfile = useCallback(async (session) => {
                if (session?.user) {
                    setUser(session.user);
                    try {
                        const { data: userProfile, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', session.user.id)
                            .maybeSingle();

                        if (error) {
                            throw error;
                        }
                        
                        setProfile(userProfile);
                    } catch (error) { 
                        console.error("Error fetching profile:", error); 
                        setProfile(null); 
                    }
                } else { 
                    setUser(null); 
                    setProfile(null); 
                }
            }, []);

            useEffect(() => {
                if (!supabase) {
                    setLoading(false);
                    return;
                }

                const getInitialSession = async () => {
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        await loadUserAndProfile(session);
                    } catch (error) {
                        console.error("Error initializing session:", error);
                    } finally {
                        setLoading(false);
                    }
                };

                getInitialSession();

                const { data: authListener } = supabase.auth.onAuthStateChange(async (_event, session) => {
                    setLoading(true);
                    await loadUserAndProfile(session);
                    setLoading(false);
                });

                return () => {
                    authListener?.subscription.unsubscribe();
                };
            }, [loadUserAndProfile]);


            const value = { user, profile, loading, signIn: (d) => supabase.auth.signInWithPassword(d), signUp: (d) => supabase.auth.signUp(d), signOut: () => supabase.auth.signOut(), refreshProfile: () => loadUserAndProfile({user}) };
            return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
        };
        const useAuth = () => useContext(AuthContext);

        const ThemeContext = createContext(null);
        const ThemeProvider = ({ children }) => {
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'dark');

            useEffect(() => {
                const root = window.document.documentElement;
                root.classList.remove('light', 'dark');
                root.classList.add(theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            };

            return <ThemeContext.Provider value={{ theme, toggleTheme }}>{children}</ThemeContext.Provider>;
        };
        const useTheme = () => useContext(ThemeContext);
        
        const ToastContext = createContext(null);
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = useCallback((content, type = 'info') => { const id = Date.now(); setToasts(ts => [...ts, { id, content, type }]); setTimeout(() => setToasts(ts => ts.filter(t => t.id !== id)), 5000); }, []);
            return <ToastContext.Provider value={{ addToast }}>{children}<ToastContainer toasts={toasts} /></ToastContext.Provider>;
        };
        const useToast = () => useContext(ToastContext);

        // --- UI COMPONENTS ---
        const Card = ({ children, className = '', id = '' }) => <div id={id} className={`bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg p-4 sm:p-6 ${className}`}>{children}</div>;
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => { const base = 'px-4 h-10 rounded-md font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 transition-colors inline-flex items-center justify-center gap-2 disabled:opacity-50 disabled:pointer-events-none'; const variants = { primary: 'bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600', secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600', danger: 'bg-red-600 text-white hover:bg-red-700', ghost: 'hover:bg-gray-100 dark:hover:bg-gray-700' }; return <button onClick={onClick} type={type} className={`${base} ${variants[variant]} ${className}`} disabled={disabled}>{children}</button>; };
        const Input = React.forwardRef(({ id, type, placeholder, className = '', ...props }, ref) => <input id={id} type={type} placeholder={placeholder} ref={ref} className={`w-full h-10 px-3 py-2 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${className}`} {...props} />);
        const Select = React.forwardRef(({ id, children, className = '', ...props }, ref) => <select id={id} ref={ref} className={`w-full h-10 px-3 py-2 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 appearance-none ${className}`} {...props}>{children}</select>);
        const Textarea = React.forwardRef(({ id, placeholder, className = '', ...props }, ref) => <textarea id={id} placeholder={placeholder} ref={ref} className={`w-full p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${className}`} {...props} />);
        const PageWrapper = ({ title, children, id, actions }) => (
            <div id={id} className="p-4 sm:p-6">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl sm:text-3xl font-bold">{title}</h2>
                    {actions && <div className="flex gap-2">{actions}</div>}
                </div>
                {children}
            </div>
        );
        const Toast = ({ content, type }) => { const icons = { info: <Check size={20}/>, error: <AlertCircle size={20}/> }; return ( <div className={`flex items-center gap-4 p-4 w-full max-w-sm rounded-lg shadow-lg border ${type === 'error' ? 'bg-red-100 border-red-200 text-red-800' : 'bg-gray-100 border-gray-200 text-gray-800'} dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200`}> {icons[type]} <p className="font-medium">{content}</p> </div> ); };
        const ToastContainer = ({ toasts }) => <div className="fixed bottom-0 right-0 p-4 sm:p-6 space-y-4 z-[100] no-print">{toasts.map(toast => <Toast key={toast.id} {...toast} />)}</div>;
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4 no-print" onClick={onClose}>
                    <div className="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-lg shadow-2xl w-full max-w-2xl border border-gray-200 dark:border-gray-700" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700"><h3 className="text-xl font-semibold">{title}</h3><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><X size={20} /></button></div>
                        <div className="p-6 max-h-[70vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };
        const Skeleton = ({ className }) => <div className={`animate-pulse rounded-md bg-gray-200 dark:bg-gray-700 ${className}`} />;
        
        // --- LAYOUT COMPONENTS ---
        const Sidebar = ({ isSidebarOpen, setSidebarOpen, setCurrentPage }) => {
            const { profile } = useAuth();
            const navItems = [ 
                { name: 'Home', icon: Home, page: 'home' }, 
                { name: 'Projects', icon: FolderKanban, page: 'projects' }, 
                { name: 'Roles', icon: BookUser, page: 'roles' },
                { name: 'Admin', icon: Shield, page: 'admin', roles: ['global_admin', 'role_admin'] }, 
                { name: 'Twilio', icon: MessageSquare, page: 'twilio' }, 
                { name: 'Email', icon: Mail, page: 'email' }, 
                { name: 'Profile', icon: User, page: 'profile' }, 
                { name: 'Help', icon: LifeBuoy, page: 'help' }, 
            ];
            const handleNavClick = (page) => { setCurrentPage(page); if (window.innerWidth < 768) setSidebarOpen(false); };
            const asideClass = `fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-40 transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 no-print`;
            return (<>
                {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-30 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                <aside className={asideClass}>
                    <div className="flex items-center justify-between h-16 px-6 border-b border-gray-200 dark:border-gray-700"><h1 className="text-xl font-bold text-blue-600 dark:text-blue-500">CostCalc</h1><button onClick={() => setSidebarOpen(false)} className="md:hidden"><X size={24} /></button></div>
                    <nav className="flex-grow p-4"><ul>{navItems.map(item => { if (item.roles && !item.roles.includes(profile?.role)) return null; return (<li key={item.name}><a href="#" onClick={(e) => { e.preventDefault(); handleNavClick(item.page); }} className="flex items-center px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"><item.icon size={20} className="mr-3" /><span>{item.name}</span></a></li>); })}</ul></nav>
                </aside>
            </>);
        };
        const Header = ({ setSidebarOpen }) => {
            const { theme, toggleTheme } = useTheme(); const { user, profile, signOut } = useAuth(); const { addToast } = useToast();
            const [notifications, setNotifications] = useState([]);
            const [isNotifOpen, setIsNotifOpen] = useState(false);

            useEffect(() => {
                if (!user || !supabase) return;
                const fetchNotifications = async () => { const { data, error } = await supabase.from('notifications').select('*').eq('user_id', user.id).order('created_at', { ascending: false }); if (error) addToast(`Error fetching notifications: ${error.message}`, 'error'); else setNotifications(data); };
                fetchNotifications();
                const channel = supabase.channel('public:notifications').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${user.id}` }, payload => { setNotifications(current => [payload.new, ...current]); addToast('You have a new notification!', 'info'); }).subscribe();
                return () => supabase.removeChannel(channel);
            }, [user, addToast]);

            const unreadCount = notifications.filter(n => !n.read).length;
            const handleMarkAsRead = async (notifId) => { if (!supabase) return; const { error } = await supabase.from('notifications').update({ read: true }).eq('id', notifId); if (!error) setNotifications(notifications.map(n => n.id === notifId ? {...n, read: true} : n)); };
            
            return (
                <header className="flex items-center justify-between h-16 px-4 sm:px-6 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-20 no-print">
                    <button onClick={() => setSidebarOpen(true)} className="md:hidden"><Menu size={24} /></button>
                    <div className="hidden md:block"></div>
                    <div className="flex items-center space-x-2 sm:space-x-4">
                        <Button variant="ghost" onClick={toggleTheme} className="p-2 h-10 w-10">
                           {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                        </Button>
                        <div className="relative">
                            <Button variant="ghost" onClick={() => setIsNotifOpen(!isNotifOpen)} className="p-2 h-10 w-10 relative"><Bell size={20} />{unreadCount > 0 && <span className="absolute top-1.5 right-1.5 block h-2 w-2 rounded-full bg-blue-600 ring-2 ring-white dark:ring-gray-800"></span>}</Button>
                            {isNotifOpen && <div className="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50"><div className="p-3 font-semibold border-b border-gray-200 dark:border-gray-700">Notifications</div><div className="max-h-96 overflow-y-auto">{notifications.map(n => (<div key={n.id} className={`p-3 border-b border-gray-200/50 dark:border-gray-700/50 ${!n.read ? 'bg-blue-50 dark:bg-blue-900/20' : ''}`}><p className="text-sm">{n.text}</p><div className="flex justify-between items-center mt-1"><span className="text-xs text-gray-500 dark:text-gray-400">{new Date(n.created_at).toLocaleString()}</span>{!n.read && <button onClick={() => handleMarkAsRead(n.id)} className="text-xs text-blue-600 dark:text-blue-500 hover:underline">Mark as read</button>}</div></div>))}{notifications.length === 0 && <p className="text-center text-sm text-gray-500 dark:text-gray-400 py-4">No new notifications.</p>}</div></div>}
                        </div>
                        {profile && (<div className="flex items-center space-x-2"><div className="text-right hidden sm:block"><p className="font-semibold text-sm">{profile.first_name || 'User'}</p><p className="text-xs text-gray-500 dark:text-gray-400">{user.email}</p></div><Button variant="ghost" onClick={signOut} title="Sign Out" className="p-2 h-10 w-10"><LogOut size={20} /></Button></div>)}
                    </div>
                </header>
            );
        };

        // --- PAGE COMPONENTS ---
        
        const TeamManagement = ({ team, onTeamChange, settings, roleCatalog }) => {
            const [isMultiRoleModalOpen, setIsMultiRoleModalOpen] = useState(false);
            const [isMonthlyPlanModalOpen, setIsMonthlyPlanModalOpen] = useState(false);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [planningMember, setPlanningMember] = useState(null);
            const [editingMember, setEditingMember] = useState(null);

            const handleAddRoles = (roles) => {
                const newMembers = roles.map(role => ({ 
                    id: `${role.id}-${Date.now()}`, 
                    role_id: role.id, 
                    role: role.role, 
                    costRate: role.rate, 
                    billRate: role.rate * 1.5, 
                    monthlyAllocation: Array(settings.duration).fill(100) 
                }));
                onTeamChange([...team, ...newMembers]);
            };
            
            const handleRemoveMember = (id) => onTeamChange(team.filter(m => m.id !== id));
            
            const openMonthlyPlan = (member) => { 
                setPlanningMember(member); 
                setIsMonthlyPlanModalOpen(true); 
            };
            const handleSaveMonthlyPlan = (memberId, newAllocations) => { 
                onTeamChange(team.map(m => m.id === memberId ? { ...m, monthlyAllocation: newAllocations } : m)); 
            };

            const openEditModal = (member) => { 
                setEditingMember(member); 
                setIsEditModalOpen(true); 
            };
            const handleSaveEditedMember = (updatedMember) => { 
                onTeamChange(team.map(m => m.id === updatedMember.id ? updatedMember : m)); 
            };

            const getAverageAllocation = (allocations) => { 
                if (!allocations || allocations.length === 0) return 0; 
                const sum = allocations.reduce((a, b) => a + b, 0); 
                return (sum / allocations.length).toFixed(0); 
            }

            return (
                <Card>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-semibold flex items-center gap-2"><Users size={20}/> Team Members</h3><Button onClick={() => setIsMultiRoleModalOpen(true)}><Plus size={16}/> Add from Catalog</Button></div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th className="px-6 py-3">Role</th>
                                    <th className="px-6 py-3">Cost/hr</th>
                                    <th className="px-6 py-3">Bill/hr</th>
                                    <th className="px-6 py-3">Avg. Allocation</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                {team.map(member => (
                                    <tr key={member.id}>
                                        <td className="px-6 py-4 font-medium">{member.role}</td>
                                        <td className="px-6 py-4">${parseFloat(member.costRate).toFixed(2)}</td>
                                        <td className="px-6 py-4">${parseFloat(member.billRate).toFixed(2)}</td>
                                        <td className="px-6 py-4">{getAverageAllocation(member.monthlyAllocation)}%</td>
                                        <td className="px-6 py-4 flex gap-2">
                                            <Button variant="ghost" size="sm" onClick={() => openMonthlyPlan(member)}><CalendarDays size={16}/></Button>
                                            <Button variant="ghost" size="sm" onClick={() => openEditModal(member)}><Edit size={16}/></Button>
                                            <Button variant="ghost" size="sm" className="text-red-500 hover:bg-red-500/10" onClick={() => handleRemoveMember(member.id)}><Trash2 size={16}/></Button>
                                        </td>
                                    </tr>
                                ))}
                                {team.length === 0 && (
                                    <tr>
                                        <td colSpan="5" className="text-center py-8 text-gray-500 dark:text-gray-400">No team members yet.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    <MultiRoleSelectionModal isOpen={isMultiRoleModalOpen} onClose={() => setIsMultiRoleModalOpen(false)} onAddRoles={handleAddRoles} roleCatalog={roleCatalog} />
                    {planningMember && <MonthlyPlanningModal isOpen={isMonthlyPlanModalOpen} onClose={() => setIsMonthlyPlanModalOpen(false)} member={planningMember} duration={settings.duration} onSave={handleSaveMonthlyPlan} />}
                    {editingMember && <EditTeamMemberModal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} member={editingMember} onSave={handleSaveEditedMember} />}
                </Card>
            );
        };

        const HomePage = ({ projectToLoad, clearProjectToLoad, templateToLoad, clearTemplateToLoad }) => {
            const { user } = useAuth();
            const { addToast } = useToast();
            const [settings, setSettings] = useState({ duration: 6, workingHours: 160, currency: 'USD', taxRate: 0, riskBuffer: 10, profitMargin: 20, includesTax: false });
            const [team, setTeam] = useState([]);
            const [projectName, setProjectName] = useState('New Project');
            const [projectDescription, setProjectDescription] = useState('');
            const [roleCatalog, setRoleCatalog] = useState([]);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [exchangeRates, setExchangeRates] = useState({ USD: 1.0 });

            useEffect(() => {
                const fetchRoleCatalog = async () => {
                    if (!supabase) return;
                    const { data, error } = await supabase.from('role_catalog').select('*').eq('is_active', true);
                    if (error) addToast('Could not fetch role catalog.', 'error');
                    else setRoleCatalog(data || []);
                };
                fetchRoleCatalog();
            }, [addToast]);

            useEffect(() => {
                if (projectToLoad) {
                    setProjectName(projectToLoad.name);
                    setSettings(projectToLoad.settings);
                    setTeam(projectToLoad.team || []);
                    setProjectDescription(projectToLoad.settings?.description || '');
                    addToast(`Loaded project: ${projectToLoad.name}`, 'info');
                    clearProjectToLoad();
                }
            }, [projectToLoad, clearProjectToLoad, addToast]);

            useEffect(() => {
                const fetchRates = async () => {
                    try {
                        const response = await fetch(`https://api.exchangerate.host/latest?base=USD&symbols=${SUPPORTED_CURRENCIES.join(',')}`);
                        const data = await response.json();
                        if(data.success) {
                            setExchangeRates(data.rates);
                        } else {
                            addToast('Could not fetch latest currency rates.', 'error');
                        }
                    } catch (error) {
                        addToast('Currency API is currently unavailable.', 'error');
                    }
                };
                fetchRates();
            }, [addToast]);

            const { totalCost, teamSize, avgMonthlyCost, totalBilling, blendedCostRate, blendedBillRate, avgMarkup, totalMonthlyHours, monthlyBilling } = useMemo(() => {
                let totalHours = 0;
                let cost = 0;
                
                team.forEach(member => {
                    const memberHours = (member.monthlyAllocation || []).reduce((sum, alloc) => sum + (settings.workingHours * (alloc / 100)), 0);
                    totalHours += memberHours;
                    cost += memberHours * member.costRate;
                });
                
                const costWithBuffer = cost * (1 + settings.riskBuffer / 100);
                const billing = costWithBuffer * (1 + settings.profitMargin / 100);

                const conversionRate = exchangeRates[settings.currency] || 1;

                const size = team.length;
                const monthlyCost = size > 0 && settings.duration > 0 ? cost / settings.duration : 0;
                const mBilling = size > 0 && settings.duration > 0 ? billing / settings.duration : 0;
                const bCostRate = totalHours > 0 ? cost / totalHours : 0;
                const bBillRate = totalHours > 0 ? billing / totalHours : 0;
                const markup = bCostRate > 0 ? ((bBillRate - bCostRate) / bCostRate) * 100 : 0;
                const monthlyHours = totalHours / settings.duration || 0;

                return { 
                    totalCost: cost * conversionRate, 
                    teamSize: size, 
                    avgMonthlyCost: monthlyCost * conversionRate,
                    totalBilling: billing * conversionRate,
                    monthlyBilling: mBilling * conversionRate,
                    blendedCostRate: bCostRate * conversionRate,
                    blendedBillRate: bBillRate * conversionRate,
                    avgMarkup: markup,
                    totalMonthlyHours: monthlyHours
                };
            }, [team, settings, exchangeRates]);

            const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: settings.currency }).format(amount);
            
            const handleTeamChange = (newTeam) => setTeam(newTeam);
            
            const handleSaveSettings = (newSettings, newName, newDesc) => {
                setSettings(newSettings);
                setProjectName(newName);
                setProjectDescription(newDesc);
                setIsSettingsModalOpen(false);
                addToast('Project settings updated!', 'info');
            };
            
            const handleExportPDF = () => {
                const doc = new jsPDF();
                doc.setFontSize(20);
                doc.text('Project Cost Report', 14, 22);
                doc.setFontSize(12);
                doc.text(`Project: ${projectName}`, 14, 32);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 38);

                autoTable(doc, {
                    startY: 50,
                    head: [['Metric', 'Value']],
                    body: [
                        ['Total Project Cost', formatCurrency(totalCost)],
                        ['Total Project Billing', formatCurrency(totalBilling)],
                        ['Team Size', `${teamSize} members`],
                        ['Duration', `${settings.duration} months`],
                        ['Average Monthly Cost', formatCurrency(avgMonthlyCost)],
                    ],
                    theme: 'striped',
                    headStyles: { fillColor: [37, 99, 235] },
                });

                if (team.length > 0) {
                    autoTable(doc, {
                        startY: doc.lastAutoTable.finalY + 10,
                        head: [['Role', 'Cost/hr', 'Bill/hr', 'Avg. Allocation']],
                        body: team.map(m => [
                            m.role,
                            formatCurrency(m.costRate * (exchangeRates[settings.currency] || 1)),
                            formatCurrency(m.billRate * (exchangeRates[settings.currency] || 1)),
                            `${(m.monthlyAllocation.reduce((a, b) => a + b, 0) / m.monthlyAllocation.length).toFixed(0)}%`
                        ]),
                        theme: 'grid',
                        headStyles: { fillColor: [37, 99, 235] },
                    });
                }
                
                doc.save(`${projectName.replace(/\s+/g, '_')}_report.pdf`);
                addToast('PDF export started.', 'info');
            };

            const handleSave = async (isTemplate = false) => {
                if (!supabase || !user) { 
                    addToast('You must be logged in to save.', 'error'); 
                    return; 
                }
                
                const table = isTemplate ? 'project_templates' : 'projects';
                const projectData = { 
                    name: projectName, 
                    owner_id: user.id, 
                    settings: {...settings, description: projectDescription},
                    team: team,
                    is_template: isTemplate,
                };
                
                const { error } = await supabase.from(table).insert([projectData]);

                if (error) {
                    addToast(`Error saving ${isTemplate ? 'template' : 'project'}: ${error.message}`, 'error');
                } else {
                    addToast(`${isTemplate ? 'Template' : 'Project'} saved successfully!`, 'info');
                }
            };

            return (
                <PageWrapper 
                    title="Professional Calculator"
                    actions={
                        <>
                            <Button onClick={() => handleSave(true)} variant="secondary"><Copy size={16}/> Save as Template</Button>
                            <Button onClick={() => handleSave(false)} variant="primary"><Save size={16}/> Save Project</Button>
                        </>
                    }
                >
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Card className="flex justify-between items-start">
                                <div>
                                    <p className="text-gray-500 dark:text-gray-400">Total Project Cost</p>
                                    <p className="text-3xl font-bold">{formatCurrency(totalCost)}</p>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">{settings.duration} month duration</p>
                                </div>
                                <DollarSign className="text-gray-400" />
                            </Card>
                            <Card className="flex justify-between items-start">
                                <div>
                                    <p className="text-gray-500 dark:text-gray-400">Team Size</p>
                                    <p className="text-3xl font-bold">{teamSize}</p>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">Active team members</p>
                                </div>
                                <Users className="text-gray-400" />
                            </Card>
                            <Card className="flex justify-between items-start">
                                <div>
                                    <p className="text-gray-500 dark:text-gray-400">Avg. Monthly Cost</p>
                                    <p className="text-3xl font-bold">{formatCurrency(avgMonthlyCost)}</p>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">Per month average</p>
                                </div>
                                <BarChart3 className="text-gray-400" />
                            </Card>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 space-y-6">
                                <Card>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-semibold flex items-center gap-2"><Settings size={20}/> Project Settings</h3>
                                        <div className="flex gap-2">
                                            <Button variant="ghost" onClick={() => setIsSettingsModalOpen(true)}>Edit</Button>
                                            <Button variant="ghost" onClick={handleExportPDF}><Download size={16}/></Button>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <p className="font-semibold">{projectName}</p>
                                            <p className="text-sm text-gray-500 dark:text-gray-400">{settings.duration} months</p>
                                        </div>
                                        <div>
                                            <p className="font-semibold">Description</p>
                                            <p className="text-sm text-gray-500 dark:text-gray-400">{projectDescription || 'No description provided'}</p>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4">
                                            <div><p className="text-sm text-gray-500 dark:text-gray-400">Monthly Hours</p><p className="font-semibold">{settings.workingHours} h</p></div>
                                            <div><p className="text-sm text-gray-500 dark:text-gray-400">Tax Rate (%)</p><p className="font-semibold">{settings.taxRate}%</p></div>
                                            <div><p className="text-sm text-gray-500 dark:text-gray-400">Risk Buffer (%)</p><p className="font-semibold">{settings.riskBuffer}%</p></div>
                                            <div><p className="text-sm text-gray-500 dark:text-gray-400">Profit Margin (%)</p><p className="font-semibold">{settings.profitMargin}%</p></div>
                                        </div>
                                        <div>
                                            <p className="font-semibold">Currency</p>
                                            <p className="text-sm text-gray-500 dark:text-gray-400">{settings.currency}</p>
                                        </div>
                                    </div>
                                </Card>
                                <TeamManagement team={team} onTeamChange={handleTeamChange} settings={settings} roleCatalog={roleCatalog} />
                            </div>
                            <div>
                                <Card>
                                     <h3 className="text-lg font-semibold mb-4 flex items-center gap-2"><BarChart3 size={20}/> Cost Summary</h3>
                                     <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6">
                                        <div>
                                            <h4 className="font-semibold mb-2">Cost Analysis</h4>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between"><span>Project Cost</span><span>{formatCurrency(totalCost)}</span></div>
                                                <div className="flex justify-between"><span>Project Billing</span><span>{formatCurrency(totalBilling)}</span></div>
                                                <div className="flex justify-between"><span>Monthly Cost</span><span>{formatCurrency(avgMonthlyCost)}</span></div>
                                                <div className="flex justify-between"><span>Monthly Billing</span><span>{formatCurrency(monthlyBilling)}</span></div>
                                                <div className="flex justify-between"><span>Margin</span><span>{((totalBilling - totalCost) / totalBilling * 100 || 0).toFixed(1)}%</span></div>
                                            </div>
                                        </div>
                                         <div>
                                            <h4 className="font-semibold mb-2">Team Statistics</h4>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between"><span>Team Members</span><span>{teamSize}</span></div>
                                                <div className="flex justify-between"><span>Monthly Hours</span><span>{totalMonthlyHours.toFixed(0)}</span></div>
                                                <div className="flex justify-between"><span>Blended Cost Rate</span><span>{formatCurrency(blendedCostRate)}/hr</span></div>
                                                <div className="flex justify-between"><span>Blended Bill Rate</span><span>{formatCurrency(blendedBillRate)}/hr</span></div>
                                                <div className="flex justify-between"><span>Average Markup</span><span>{avgMarkup.toFixed(1)}%</span></div>
                                            </div>
                                        </div>
                                     </div>
                                </Card>
                            </div>
                        </div>
                    </div>
                    <EditProjectSettingsModal 
                        isOpen={isSettingsModalOpen}
                        onClose={() => setIsSettingsModalOpen(false)}
                        settings={settings}
                        projectName={projectName}
                        projectDescription={projectDescription}
                        onSave={handleSaveSettings}
                    />
                </PageWrapper>
            );
        };

        const ProjectsPage = ({ loadProject, loadTemplate }) => {
            const { user } = useAuth();
            const { addToast } = useToast();
            const [view, setView] = useState('projects'); // 'projects' or 'templates'
            const [projects, setProjects] = useState([]);
            const [templates, setTemplates] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'updated_at', direction: 'desc' });
            const [selected, setSelected] = useState([]);
            const [sharingProject, setSharingProject] = useState(null);

            const fetchData = useCallback(async () => {
                if (!supabase || !user) return;
                setIsLoading(true);
                if (view === 'projects') {
                    const { data, error } = await supabase.from('projects').select('*').eq('owner_id', user.id);
                    if (error) addToast('Error fetching projects: ' + error.message, 'error');
                    else setProjects(data);
                } else {
                    const { data, error } = await supabase.from('project_templates').select('*').eq('owner_id', user.id);
                    if (error) addToast('Error fetching templates: ' + error.message, 'error');
                    else setTemplates(data);
                }
                setIsLoading(false);
            }, [user, addToast, view]);

            useEffect(() => { fetchData(); }, [fetchData]);
            
            const handleBulkDelete = async () => {
                if (selected.length === 0) return;
                if (window.confirm(`Are you sure you want to delete ${selected.length} item(s)?`)) {
                    const table = view === 'projects' ? 'projects' : 'project_templates';
                    const { error } = await supabase.from(table).delete().in('id', selected);
                    if (error) addToast('Error deleting items: ' + error.message, 'error');
                    else { addToast(`${selected.length} items deleted.`, 'info'); fetchData(); setSelected([]); }
                }
            };

            const handleShare = async (shareData) => {
                const { data: recipient, error: recipientError } = await supabase.from('profiles').select('id').eq('email', shareData.email).single();
                if (recipientError || !recipient) { addToast('User with that email not found.', 'error'); return; }

                const { error } = await supabase.from('project_shares').insert([{ project_id: sharingProject.id, shared_by: user.id, shared_with: recipient.id, permission: shareData.permission }]);
                if (error) { addToast('Error sharing project: ' + error.message, 'error'); } 
                else { addToast('Project shared successfully!', 'info'); setSharingProject(null); }
            };

            const sortedAndFilteredData = useMemo(() => {
                const data = view === 'projects' ? projects : templates;
                let filtered = data.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));
                return filtered.sort((a, b) => {
                    if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [projects, templates, view, searchTerm, sortConfig]);
            
            const handleSelectAll = (e) => {
                if (e.target.checked) setSelected(sortedAndFilteredData.map(p => p.id));
                else setSelected([]);
            };
            const handleSelectOne = (id) => {
                if (selected.includes(id)) setSelected(selected.filter(s => s !== id));
                else setSelected([...selected, id]);
            };

            return (
                 <PageWrapper title="Projects & Templates">
                    <div className="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                        <button onClick={() => setView('projects')} className={`px-4 py-2 text-sm font-medium ${view === 'projects' ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-500' : 'text-gray-500 dark:text-gray-400'}`}>My Projects</button>
                        <button onClick={() => setView('templates')} className={`px-4 py-2 text-sm font-medium ${view === 'templates' ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-500' : 'text-gray-500 dark:text-gray-400'}`}>My Templates</button>
                    </div>
                    <Card>
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                            <div className="relative w-full sm:max-w-xs">
                                <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                <Input placeholder="Search by name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="pl-10" />
                            </div>
                            {selected.length > 0 && <Button variant="danger" onClick={handleBulkDelete}>Delete ({selected.length})</Button>}
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th className="p-4"><input type="checkbox" onChange={handleSelectAll} checked={selected.length === sortedAndFilteredData.length && sortedAndFilteredData.length > 0} className="rounded" /></th>
                                        <th className="px-6 py-3">Name</th>
                                        <th className="px-6 py-3">Last Modified</th>
                                        <th className="px-6 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                    {isLoading ? (<tr><td colSpan="4" className="text-center p-4">Loading...</td></tr>) : 
                                    sortedAndFilteredData.map(item => (
                                        <tr key={item.id}>
                                            <td className="p-4"><input type="checkbox" checked={selected.includes(item.id)} onChange={() => handleSelectOne(item.id)} className="rounded" /></td>
                                            <td className="px-6 py-4 font-medium">{item.name}</td>
                                            <td className="px-6 py-4">{new Date(item.updated_at).toLocaleString()}</td>
                                            <td className="px-6 py-4 flex gap-2">
                                                <Button variant="secondary" onClick={() => view === 'projects' ? loadProject(item) : loadTemplate(item)}>Load</Button>
                                                {view === 'projects' && <Button variant="ghost" onClick={() => setSharingProject(item)}><Share2 size={16}/></Button>}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                    {sharingProject && <ShareProjectModal isOpen={!!sharingProject} onClose={() => setSharingProject(null)} project={sharingProject} onShare={handleShare} />}
                 </PageWrapper>
            );
        };
        
        const AdminPage = () => {
            const { profile } = useAuth();
            const [activeTab, setActiveTab] = useState('users');

            useEffect(() => {
                if(profile?.role === 'role_admin') {
                    setActiveTab('roles');
                } else {
                    setActiveTab('users');
                }
            }, [profile]);
            
            const tabs = [
                { id: 'users', label: 'User Management', icon: Users, roles: ['global_admin'] },
                { id: 'roles', label: 'Role Catalog', icon: BookUser, roles: ['global_admin', 'role_admin'] },
                { id: 'audit', label: 'Audit Log', icon: FileClock, roles: ['global_admin'] },
            ];

            const renderContent = () => {
                switch (activeTab) {
                    case 'users': return <UserManagementTab />;
                    case 'roles': return <RoleManagementTab />;
                    case 'audit': return <AuditLogTab />;
                    default: return null;
                }
            };

            return (
                <PageWrapper title="Admin Dashboard">
                    <div className="flex flex-col md:flex-row gap-8">
                        <div className="md:w-1/4">
                            <nav className="flex flex-col space-y-2">
                                {tabs.map(tab => {
                                    if (!tab.roles.includes(profile?.role)) return null;
                                    const isActive = activeTab === tab.id;
                                    return (
                                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg transition-colors ${isActive ? 'bg-blue-500/10 text-blue-500' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`}>
                                            <tab.icon size={20} />
                                            <span>{tab.label}</span>
                                        </button>
                                    );
                                })}
                            </nav>
                        </div>
                        <div className="md:w-3/4">
                            <Card>{renderContent()}</Card>
                        </div>
                    </div>
                </PageWrapper>
            );
        };

        const ProfilePage = () => <PageWrapper title="My Profile"><Card><p className="text-gray-500 dark:text-gray-400">Users will be able to manage their profile information here.</p></Card></PageWrapper>;
        const HelpPage = () => <PageWrapper title="Help"><Card><p className="text-gray-500 dark:text-gray-400">This section will contain helpful guides and FAQs.</p></Card></PageWrapper>;
        
        const AuthPage = () => {
            const { signIn, signUp } = useAuth(); 
            const { addToast } = useToast();
            const [isLogin, setIsLogin] = useState(true); 
            const [email, setEmail] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false);
            
            const handleAuth = async (e) => {
                e.preventDefault(); 
                setLoading(true);
                const { error } = isLogin ? await signIn({ email, password }) : await signUp({ email, password });
                if (error) {
                    addToast(error.message, 'error');
                } else {
                    addToast(isLogin ? 'Signed in successfully!' : 'Check your email for verification!', 'info');
                }
                setLoading(false);
            };
            return (<div className="flex flex-col justify-center items-center min-h-screen bg-gray-50 dark:bg-gray-900 p-4"><div className="w-full max-w-sm"><div className="text-center mb-6"><h1 className="text-3xl font-bold text-blue-600 dark:text-blue-500">CostCalc</h1><p className="text-gray-500 dark:text-gray-400">{isLogin ? 'Sign in to your account' : 'Create a new account'}</p></div><Card><form onSubmit={handleAuth} className="space-y-4"><div><label className="text-sm font-medium">Email</label><Input type="email" value={email} onChange={e => setEmail(e.target.value)} required /></div><div><label className="text-sm font-medium">Password</label><Input type="password" value={password} onChange={e => setPassword(e.target.value)} required /></div><Button type="submit" variant="primary" className="w-full" disabled={loading}>{loading ? 'Processing...' : (isLogin ? 'Sign In' : 'Sign Up')}</Button></form></Card><p className="text-center mt-4 text-sm"><button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 dark:text-blue-500 hover:underline">{isLogin ? 'Need an account? Sign Up' : 'Already have an account? Sign In'}</button></p></div></div>);
        };
        
        const TwilioPage = () => {
            const [credentials, setCredentials] = useState({ sid: '', token: '', twilioPhone: '' });
            const [message, setMessage] = useState({ to: '', text: '' });
            const [status, setStatus] = useState({ sending: false, result: null, message: '' });
            const { addToast } = useToast();

            const handleSend = () => {
                if (!credentials.sid || !credentials.token || !credentials.twilioPhone || !message.to || !message.text) {
                    addToast('Please fill all fields.', 'error');
                    return;
                }
                setStatus({ sending: true, result: null, message: '' });
                // SIMULATED API CALL
                setTimeout(() => {
                    const isSuccess = Math.random() > 0.3; // 70% chance of success
                    if (isSuccess) {
                        setStatus({ sending: false, result: 'success', message: 'SMS sent successfully! (Simulated)' });
                    } else {
                        setStatus({ sending: false, result: 'error', message: 'Failed to send SMS. Check credentials. (Simulated)' });
                    }
                }, 1500);
            };

            return (
                <PageWrapper title="Twilio SMS Integration">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <Card>
                            <h3 className="text-lg font-semibold mb-4">Twilio Credentials</h3>
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="sid" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Account SID</label>
                                    <Input id="sid" type="password" value={credentials.sid} onChange={e => setCredentials({...credentials, sid: e.target.value})} />
                                </div>
                                <div>
                                    <label htmlFor="token" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Auth Token</label>
                                    <Input id="token" type="password" value={credentials.token} onChange={e => setCredentials({...credentials, token: e.target.value})} />
                                </div>
                                <div>
                                    <label htmlFor="twilioPhone" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Twilio Phone Number</label>
                                    <Input id="twilioPhone" type="text" value={credentials.twilioPhone} onChange={e => setCredentials({...credentials, twilioPhone: e.target.value})} />
                                </div>
                            </div>
                        </Card>
                        <Card>
                            <h3 className="text-lg font-semibold mb-4">Send Test Message</h3>
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="to" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Recipient Number</label>
                                    <Input id="to" type="text" value={message.to} onChange={e => setMessage({...message, to: e.target.value})} placeholder="+1234567890" />
                                </div>
                                <div>
                                    <label htmlFor="text" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Message</label>
                                    <Textarea id="text" value={message.text} onChange={e => setMessage({...message, text: e.target.value})} rows="4" />
                                </div>
                                <Button onClick={handleSend} disabled={status.sending}>{status.sending ? 'Sending...' : 'Send Test SMS'}</Button>
                                {status.result && (
                                    <div className={`mt-4 p-3 rounded-md text-sm ${status.result === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                        {status.message}
                                    </div>
                                )}
                            </div>
                        </Card>
                    </div>
                </PageWrapper>
            );
        };

        const EmailPage = () => {
            const [emailData, setEmailData] = useState({ sender: '', recipient: '', subject: '', body: '' });
            const [status, setStatus] = useState({ sending: false, result: null, message: '' });
            const { addToast } = useToast();

            const handleSendEmail = () => {
                if (!emailData.sender || !emailData.recipient || !emailData.subject || !emailData.body) {
                    addToast('Please fill all fields.', 'error');
                    return;
                }
                setStatus({ sending: true, result: null, message: '' });
                // SIMULATED API CALL
                setTimeout(() => {
                    const isSuccess = Math.random() > 0.3; // 70% chance of success
                    if (isSuccess) {
                        setStatus({ sending: false, result: 'success', message: 'Email sent successfully! (Simulated)' });
                    } else {
                        setStatus({ sending: false, result: 'error', message: 'Failed to send email. (Simulated)' });
                    }
                }, 1500);
            };

            return (
                <PageWrapper title="SendGrid Email Integration">
                    <Card>
                        <div className="max-w-2xl mx-auto">
                            <h3 className="text-lg font-semibold mb-4">Compose Email</h3>
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="sender" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Sender Email</label>
                                    <Input id="sender" type="email" value={emailData.sender} onChange={e => setEmailData({...emailData, sender: e.target.value})} placeholder="sender@example.com" />
                                </div>
                                <div>
                                    <label htmlFor="recipient" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Recipient Email</label>
                                    <Input id="recipient" type="email" value={emailData.recipient} onChange={e => setEmailData({...emailData, recipient: e.target.value})} placeholder="recipient@example.com" />
                                </div>
                                <div>
                                    <label htmlFor="subject" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Subject</label>
                                    <Input id="subject" type="text" value={emailData.subject} onChange={e => setEmailData({...emailData, subject: e.target.value})} />
                                </div>
                                <div>
                                    <label htmlFor="body" className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Message Body</label>
                                    <Textarea id="body" value={emailData.body} onChange={e => setEmailData({...emailData, body: e.target.value})} rows="6" />
                                </div>
                                <Button onClick={handleSendEmail} disabled={status.sending}>{status.sending ? 'Sending...' : 'Send Email'}</Button>
                                {status.result && (
                                    <div className={`mt-4 p-3 rounded-md text-sm ${status.result === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                        {status.message}
                                    </div>
                                )}
                            </div>
                        </div>
                    </Card>
                </PageWrapper>
            );
        };
        
        // --- ADMIN SUB-COMPONENTS ---
        const UserManagementTab = () => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingUser, setEditingUser] = useState(null);
            const { addToast } = useToast();

            const fetchUsers = useCallback(async () => {
                if (!supabase) return;
                setLoading(true);
                const { data, error } = await supabase.from('profiles').select('*');
                if (error) addToast('Error fetching users: ' + error.message, 'error');
                else setUsers(data);
                setLoading(false);
            }, [addToast]);

            useEffect(() => { fetchUsers(); }, [fetchUsers]);

            const handleSaveUser = async (updatedUser) => {
                const { error } = await supabase.from('profiles').update({ role: updatedUser.role, is_active: updatedUser.is_active }).eq('id', updatedUser.id);
                if (error) {
                    addToast('Error updating user: ' + error.message, 'error');
                } else {
                    addToast('User updated successfully.', 'info');
                    fetchUsers();
                    setEditingUser(null);
                }
            };

            return (
                <div>
                    <h3 className="text-lg font-semibold mb-4">User Management</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th className="px-6 py-3">Name</th>
                                    <th className="px-6 py-3">Email</th>
                                    <th className="px-6 py-3">Role</th>
                                    <th className="px-6 py-3">Status</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                {loading ? <tr><td colSpan="5" className="text-center p-4">Loading...</td></tr> :
                                users.map(user => (
                                    <tr key={user.id}>
                                        <td className="px-6 py-4 font-medium">{user.first_name} {user.last_name}</td>
                                        <td className="px-6 py-4">{user.email}</td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 text-xs font-medium rounded-full ${user.role === 'global_admin' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'}`}>{user.role}</span></td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 text-xs font-medium rounded-full ${user.is_active ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'}`}>{user.is_active ? 'Active' : 'Inactive'}</span></td>
                                        <td className="px-6 py-4"><Button variant="ghost" onClick={() => setEditingUser(user)}><Edit size={16}/></Button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {editingUser && <EditUserModal isOpen={!!editingUser} onClose={() => setEditingUser(null)} user={editingUser} onSave={handleSaveUser} />}
                </div>
            );
        };

        const RoleManagementTab = () => {
            const [roles, setRoles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingRole, setEditingRole] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const { addToast } = useToast();
            const { user } = useAuth();

            const fetchRoles = useCallback(async () => {
                if (!supabase) return;
                setLoading(true);
                const { data, error } = await supabase.from('role_catalog').select('*');
                if (error) addToast('Error fetching roles: ' + error.message, 'error');
                else setRoles(data);
                setLoading(false);
            }, [addToast]);

            useEffect(() => { fetchRoles(); }, [fetchRoles]);

            const handleSaveRole = async (updatedRole) => {
                const { error } = await supabase.from('role_catalog').update({ role: updatedRole.role, rate: updatedRole.rate, cost_rate: updatedRole.cost_rate, location: updatedRole.location, description: updatedRole.description, is_active: updatedRole.is_active }).eq('id', updatedRole.id);
                if (error) addToast('Error updating role: ' + error.message, 'error');
                else { addToast('Role updated.', 'info'); fetchRoles(); setEditingRole(null); }
            };

            const handleAddRole = async (newRole) => {
                const { error } = await supabase.from('role_catalog').insert([{ ...newRole, created_by: user.id }]);
                if (error) addToast('Error adding role: ' + error.message, 'error');
                else { addToast('Role added.', 'info'); fetchRoles(); setIsAdding(false); }
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold">Role Catalog Management</h3>
                        <Button onClick={() => setIsAdding(true)}><Plus size={16}/> Add New Role</Button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th className="px-6 py-3">Role</th>
                                    <th className="px-6 py-3">Rate</th>
                                    <th className="px-6 py-3">Cost Rate</th>
                                    <th className="px-6 py-3">Location</th>
                                    <th className="px-6 py-3">Status</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                {loading ? <tr><td colSpan="6" className="text-center p-4">Loading...</td></tr> :
                                roles.map(role => (
                                    <tr key={role.id}>
                                        <td className="px-6 py-4 font-medium">{role.role}</td>
                                        <td className="px-6 py-4">${role.rate}</td>
                                        <td className="px-6 py-4">${role.cost_rate}</td>
                                        <td className="px-6 py-4">{role.location}</td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 text-xs font-medium rounded-full ${role.is_active ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'}`}>{role.is_active ? 'Active' : 'Inactive'}</span></td>
                                        <td className="px-6 py-4"><Button variant="ghost" onClick={() => setEditingRole(role)}><Edit size={16}/></Button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {editingRole && <EditCatalogRoleModal isOpen={!!editingRole} onClose={() => setEditingRole(null)} role={editingRole} onSave={handleSaveRole} />}
                    {isAdding && <AddCatalogRoleModal isOpen={isAdding} onClose={() => setIsAdding(false)} onSave={handleAddRole} />}
                </div>
            );
        };
        
        const AuditLogTab = () => {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const { addToast } = useToast();

            useEffect(() => {
                const fetchLogs = async () => {
                    if (!supabase) return;
                    setLoading(true);
                    // This is a placeholder as audit logs are typically populated by database triggers.
                    // For now, it will likely return an empty array.
                    const { data, error } = await supabase.from('audit_logs').select('*, profiles(first_name, last_name)').order('created_at', { ascending: false });
                    if (error) addToast('Error fetching audit logs: ' + error.message, 'error');
                    else setLogs(data);
                    setLoading(false);
                };
                fetchLogs();
            }, [addToast]);

            return (
                <div>
                    <h3 className="text-lg font-semibold mb-4">Audit Log</h3>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">Tracks all major changes within the system.</p>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th className="px-6 py-3">Timestamp</th>
                                    <th className="px-6 py-3">User</th>
                                    <th className="px-6 py-3">Action</th>
                                    <th className="px-6 py-3">Details</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                {loading ? <tr><td colSpan="4" className="text-center p-4">Loading...</td></tr> :
                                logs.length === 0 ? <tr><td colSpan="4" className="text-center p-8 text-gray-500 dark:text-gray-400">No audit logs found.</td></tr> :
                                logs.map(log => (
                                    <tr key={log.id}>
                                        <td className="px-6 py-4">{new Date(log.created_at).toLocaleString()}</td>
                                        <td className="px-6 py-4">{log.profiles ? `${log.profiles.first_name} ${log.profiles.last_name}` : 'System'}</td>
                                        <td className="px-6 py-4 font-mono text-xs">{log.action}</td>
                                        <td className="px-6 py-4">{log.table_name} (ID: {log.record_id})</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        // --- MODAL COMPONENTS ---
        const MonthlyPlanningModal = ({ isOpen, onClose, member, duration, onSave }) => {
            const [monthlyAllocation, setMonthlyAllocation] = useState(member.monthlyAllocation || Array(duration).fill(100));
            useEffect(() => { if (monthlyAllocation.length !== duration) { const newAllocation = Array(duration).fill(100); for(let i = 0; i < Math.min(monthlyAllocation.length, duration); i++) { newAllocation[i] = monthlyAllocation[i]; } setMonthlyAllocation(newAllocation); } }, [duration, monthlyAllocation]);
            const handleAllocationChange = (index, value) => { const newAllocations = [...monthlyAllocation]; newAllocations[index] = parseInt(value, 10) || 0; setMonthlyAllocation(newAllocations); };
            const handleSave = () => { onSave(member.id, monthlyAllocation); onClose(); };
            return (<Modal isOpen={isOpen} onClose={onClose} title={`Monthly Plan: ${member.role}`}><div className="space-y-4"><p className="text-gray-500 dark:text-gray-400">Set the allocation percentage for each month of the project.</p><div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">{monthlyAllocation.map((alloc, index) => (<div key={index}><label className="block text-sm font-medium mb-1">Month {index + 1}</label><Input type="number" value={alloc} onChange={e => handleAllocationChange(index, e.target.value)} min="0" max="100" /></div>))}</div><div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleSave}>Save Plan</Button></div></div></Modal>);
        };

        const EditTeamMemberModal = ({ isOpen, onClose, member, onSave }) => {
            const [formData, setFormData] = useState(member);
            const handleChange = (field, value) => {
                setFormData(prev => ({...prev, [field]: value}));
            };
            const handleSave = () => {
                onSave(formData);
                onClose();
            };
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Edit Role: ${member.role}`}>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Role Name</label><Input type="text" value={formData.role} onChange={e => handleChange('role', e.target.value)} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Cost Rate ($/hr)</label><Input type="number" value={formData.costRate} onChange={e => handleChange('costRate', parseFloat(e.target.value) || 0)} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Bill Rate ($/hr)</label><Input type="number" value={formData.billRate} onChange={e => handleChange('billRate', parseFloat(e.target.value) || 0)} /></div>
                        <div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleSave}>Save Changes</Button></div>
                    </div>
                </Modal>
            );
        };

        const MultiRoleSelectionModal = ({ isOpen, onClose, onAddRoles, roleCatalog }) => {
            const [selectedRoles, setSelectedRoles] = useState({});
            const handleToggleRole = (role) => { setSelectedRoles(prev => { const newSelection = {...prev}; if (newSelection[role.id]) delete newSelection[role.id]; else newSelection[role.id] = role; return newSelection; }); };
            const handleAdd = () => { onAddRoles(Object.values(selectedRoles)); onClose(); setSelectedRoles({}); };
            return (<Modal isOpen={isOpen} onClose={onClose} title="Add Roles from Catalog"><div className="space-y-4"><p className="text-gray-500 dark:text-gray-400">Select one or more roles to add to your project team.</p><div className="space-y-2 max-h-64 overflow-y-auto p-1">{roleCatalog.map(role => (<label key={role.id} className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer"><input type="checkbox" checked={!!selectedRoles[role.id]} onChange={() => handleToggleRole(role)} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"/><span className="font-medium flex-grow">{role.role}</span><span className="text-gray-500 dark:text-gray-400">${role.rate}/hr</span></label>))}</div><div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleAdd} disabled={Object.keys(selectedRoles).length === 0}>Add {Object.keys(selectedRoles).length || ''} Role(s)</Button></div></div></Modal>);
        };
        
        const EditUserModal = ({ isOpen, onClose, user, onSave }) => {
            const [formData, setFormData] = useState({ role: user.role, is_active: user.is_active });
            const handleSave = () => onSave({ ...user, ...formData });
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Edit User: ${user.first_name}`}>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Role</label><Select value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})}><option value="user">User</option><option value="role_admin">Role Admin</option><option value="global_admin">Global Admin</option></Select></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Status</label><Select value={formData.is_active} onChange={e => setFormData({...formData, is_active: e.target.value === 'true'})}><option value="true">Active</option><option value="false">Inactive</option></Select></div>
                        <div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleSave}>Save Changes</Button></div>
                    </div>
                </Modal>
            );
        };

        const EditCatalogRoleModal = ({ isOpen, onClose, role, onSave }) => {
            const [formData, setFormData] = useState(role);
            const handleSave = () => onSave(formData);
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Edit Role: ${role.role}`}>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Role Name</label><Input value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Rate ($/hr)</label><Input type="number" value={formData.rate} onChange={e => setFormData({...formData, rate: parseFloat(e.target.value) || 0})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Cost Rate ($/hr)</label><Input type="number" value={formData.cost_rate} onChange={e => setFormData({...formData, cost_rate: parseFloat(e.target.value) || 0})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Description</label><Textarea value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Location</label><Input value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Status</label><Select value={formData.is_active} onChange={e => setFormData({...formData, is_active: e.target.value === 'true'})}><option value="true">Active</option><option value="false">Inactive</option></Select></div>
                        <div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleSave}>Save Changes</Button></div>
                    </div>
                </Modal>
            );
        };
        
        const AddCatalogRoleModal = ({ isOpen, onClose, onSave }) => {
            const [formData, setFormData] = useState({ role: '', rate: 0, cost_rate: 0, location: 'Global', description: '', is_active: true });
            const handleSave = () => onSave(formData);
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Add New Role">
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Role Name</label><Input value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Rate ($/hr)</label><Input type="number" value={formData.rate} onChange={e => setFormData({...formData, rate: parseFloat(e.target.value) || 0})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Cost Rate ($/hr)</label><Input type="number" value={formData.cost_rate} onChange={e => setFormData({...formData, cost_rate: parseFloat(e.target.value) || 0})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Description</label><Textarea value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Location</label><Input value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} /></div>
                        <div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleSave}>Add Role</Button></div>
                    </div>
                </Modal>
            );
        };
        
        const ShareProjectModal = ({ isOpen, onClose, project, onShare }) => {
            const [email, setEmail] = useState('');
            const [permission, setPermission] = useState('view');
            
            const handleShare = () => {
                if (!email) return;
                onShare({ email, permission });
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Share "${project.name}"`}>
                    <div className="space-y-4">
                        <p className="text-sm text-gray-500 dark:text-gray-400">Enter the email of the user you want to share this project with.</p>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Email</label><Input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="colleague@example.com" /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Permission</label><Select value={permission} onChange={e => setPermission(e.target.value)}><option value="view">Can view</option><option value="edit">Can edit</option></Select></div>
                        <div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleShare}>Share Project</Button></div>
                    </div>
                </Modal>
            );
        };
        
        const EditProjectSettingsModal = ({ isOpen, onClose, settings, projectName, projectDescription, onSave }) => {
            const [currentSettings, setCurrentSettings] = useState(settings);
            const [currentName, setCurrentName] = useState(projectName);
            const [currentDesc, setCurrentDesc] = useState(projectDescription);

            useEffect(() => {
                setCurrentSettings(settings);
                setCurrentName(projectName);
                setCurrentDesc(projectDescription);
            }, [isOpen, settings, projectName, projectDescription]);

            const handleChange = (key, value) => {
                setCurrentSettings(prev => ({ ...prev, [key]: value }));
            };

            const handleSave = () => {
                onSave(currentSettings, currentName, currentDesc);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Edit Project Settings">
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Project Name</label><Input value={currentName} onChange={e => setCurrentName(e.target.value)} /></div>
                        <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Description</label><Textarea value={currentDesc} onChange={e => setCurrentDesc(e.target.value)} rows={3} /></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Duration (months)</label><Input type="number" value={currentSettings.duration} onChange={e => handleChange('duration', parseInt(e.target.value) || 1)} /></div>
                            <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Monthly Hours</label><Input type="number" value={currentSettings.workingHours} onChange={e => handleChange('workingHours', parseInt(e.target.value) || 0)} /></div>
                            <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Tax Rate (%)</label><Input type="number" value={currentSettings.taxRate} onChange={e => handleChange('taxRate', parseFloat(e.target.value) || 0)} /></div>
                            <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Risk Buffer (%)</label><Input type="number" value={currentSettings.riskBuffer} onChange={e => handleChange('riskBuffer', parseFloat(e.target.value) || 0)} /></div>
                            <div><label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Profit Margin (%)</label><Input type="number" value={currentSettings.profitMargin} onChange={e => handleChange('profitMargin', parseFloat(e.target.value) || 0)} /></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Currency</label>
                                <Select value={currentSettings.currency} onChange={e => handleChange('currency', e.target.value)}>
                                    {SUPPORTED_CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                                </Select>
                            </div>
                        </div>
                        <div className="flex justify-end gap-4 pt-4"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button variant="primary" onClick={handleSave}>Save Changes</Button></div>
                    </div>
                </Modal>
            );
        };
        
        const RolesPage = () => {
            const [roles, setRoles] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const { addToast } = useToast();

            useEffect(() => {
                const fetchRoles = async () => {
                    if (!supabase) return;
                    setIsLoading(true);
                    const { data, error } = await supabase.from('role_catalog').select('*');
                    if (error) {
                        addToast('Error fetching roles: ' + error.message, 'error');
                    } else {
                        setRoles(data || []);
                    }
                    setIsLoading(false);
                };
                fetchRoles();
            }, [addToast]);

            return (
                <PageWrapper title="Role Catalog">
                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th className="px-6 py-3">Role</th>
                                        <th className="px-6 py-3">Rate</th>
                                        <th className="px-6 py-3">Cost Rate</th>
                                        <th className="px-6 py-3">Location</th>
                                        <th className="px-6 py-3">Description</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                    {isLoading ? (<tr><td colSpan="5" className="text-center p-4">Loading...</td></tr>) : 
                                    roles.map(role => (
                                        <tr key={role.id}>
                                            <td className="px-6 py-4 font-medium">{role.role}</td>
                                            <td className="px-6 py-4">${role.rate}</td>
                                            <td className="px-6 py-4">${role.cost_rate}</td>
                                            <td className="px-6 py-4">{role.location}</td>
                                            <td className="px-6 py-4 text-gray-500 dark:text-gray-400">{role.description}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </PageWrapper>
            );
        };

        // --- ROOT APP COMPONENT ---
        const App = () => {
            const { user, profile, loading } = useAuth();
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [currentPage, setCurrentPage] = useState('home');
            const [projectToLoad, setProjectToLoad] = useState(null);
            const [templateToLoad, setTemplateToLoad] = useState(null);

            const handleLoadProject = (project) => {
                setProjectToLoad(project);
                setCurrentPage('home');
            };
            
            const handleLoadTemplate = (template) => {
                setTemplateToLoad(template);
                setCurrentPage('home');
            };
            
            const renderPage = () => {
                switch (currentPage) {
                    case 'home': return <HomePage projectToLoad={projectToLoad} clearProjectToLoad={() => setProjectToLoad(null)} templateToLoad={templateToLoad} clearTemplateToLoad={() => setTemplateToLoad(null)} />;
                    case 'projects': return <ProjectsPage loadProject={handleLoadProject} loadTemplate={handleLoadTemplate} />;
                    case 'roles': return <RolesPage />;
                    case 'admin': return <AdminPage />;
                    case 'profile': return <ProfilePage />;
                    case 'help': return <HelpPage />;
                    case 'twilio': return <TwilioPage />;
                    case 'email': return <EmailPage />;
                    default: return <HomePage />;
                }
            };

            if (loading) {
                return <div className="flex items-center justify-center h-screen bg-gray-100 dark:bg-gray-900"><div className="text-xl font-semibold text-gray-800 dark:text-gray-200">Loading...</div></div>;
            }
            
            if (!user) {
                return <AuthPage />;
            }

            return (
                <div className="flex h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
                    <Sidebar isSidebarOpen={isSidebarOpen} setSidebarOpen={setSidebarOpen} setCurrentPage={setCurrentPage} />
                    <div className="flex-1 flex flex-col overflow-hidden md:ml-64">
                        <Header setSidebarOpen={setSidebarOpen} />
                        <main className="flex-1 overflow-x-hidden overflow-y-auto">
                           {renderPage()}
                        </main>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(
            <React.StrictMode>
                <ThemeProvider>
                    <ToastProvider>
                        <AuthProvider>
                            <App />
                        </AuthProvider>
                    </ToastProvider>
                </ThemeProvider>
            </React.StrictMode>
        );
    </script>
</body>
</html>
